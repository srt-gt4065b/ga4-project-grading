<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>íŒ€ë³„ ì ìˆ˜ ìš”ì•½ ì–´ë“œë¯¼</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- TailwindCSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Apple SD Gothic Neo",
      "Malgun Gothic", sans-serif;
    }
  </style>
</head>
<body class="bg-slate-900 text-slate-100 min-h-screen flex items-center justify-center px-4">
  <div class="w-full max-w-5xl">
    <!-- ì¹´ë“œ ë˜í¼ -->
    <div class="bg-slate-800/80 shadow-2xl rounded-2xl border border-slate-700 overflow-hidden">
      <!-- í—¤ë” -->
      <div class="px-6 py-4 border-b border-slate-700 flex items-center justify-between gap-3">
        <div>
          <h1 class="text-xl md:text-2xl font-bold">íŒ€ë³„ ì ìˆ˜ ìš”ì•½ Â· ADMIN</h1>
          <p class="text-sm text-slate-400 mt-1">
            ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ë©´ íŒ€ë³„ ì´ì  / í‰ê·  / ìµœê³ ì  ìˆœìœ„ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
          </p>
        </div>
        <div id="login-status-badge"
             class="text-xs px-3 py-1 rounded-full border border-amber-400/60 text-amber-300 bg-amber-500/10">
          ğŸ”’ ì ê¸ˆ ìƒíƒœ
        </div>
      </div>

      <!-- ë¡œê·¸ì¸ ì˜ì—­ -->
      <div id="login-section" class="px-6 py-5 flex flex-col md:flex-row items-center gap-3">
        <div class="flex-1 w-full">
          <label for="admin-password" class="block text-sm mb-1 text-slate-300">
            ì–´ë“œë¯¼ ë¹„ë°€ë²ˆí˜¸
          </label>
          <input
            id="admin-password"
            type="password"
            placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš” (íŒíŠ¸: 4ìë¦¬ ìˆ«ì)"
            class="w-full rounded-xl border border-slate-600 bg-slate-900/70 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500"
          />
        </div>
        <button
          id="login-button"
          class="w-full md:w-auto whitespace-nowrap inline-flex items-center justify-center gap-2 rounded-xl bg-sky-500 hover:bg-sky-600 px-5 py-2.5 text-sm font-semibold transition-colors"
        >
          ğŸ”‘ ë¡œê·¸ì¸
        </button>
      </div>

      <!-- ë¡œê·¸ì¸ ì—ëŸ¬ -->
      <p id="login-error"
         class="px-6 pb-3 text-xs text-red-400 hidden">
        ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì…ë ¥í•´ì£¼ì„¸ìš”.
      </p>

      <!-- êµ¬ë¶„ì„  -->
      <div class="border-t border-slate-700"></div>

      <!-- ì–´ë“œë¯¼ ë‚´ìš© -->
      <div id="admin-section" class="px-4 md:px-6 py-5 hidden">
        <!-- ìƒë‹¨ ìš”ì•½ -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-5">
          <div class="bg-slate-900/60 border border-slate-700 rounded-xl p-4">
            <p class="text-xs text-slate-400 mb-1">ì´ íŒ€ ìˆ˜</p>
            <p id="summary-team-count" class="text-2xl font-bold">-</p>
          </div>
          <div class="bg-slate-900/60 border border-slate-700 rounded-xl p-4">
            <p class="text-xs text-slate-400 mb-1">ì „ì²´ í‰ê·  ì ìˆ˜</p>
            <p id="summary-global-avg" class="text-2xl font-bold">-</p>
          </div>
          <div class="bg-slate-900/60 border border-slate-700 rounded-xl p-4">
            <p class="text-xs text-slate-400 mb-1">ì „ì²´ ê¸°ë¡ ìˆ˜</p>
            <p id="summary-record-count" class="text-2xl font-bold">-</p>
          </div>
        </div>

        <!-- ë°ì´í„° ìƒˆë¡œê³ ì¹¨ ì˜ì—­ -->
        <div class="flex flex-col md:flex-row items-center justify-between gap-3 mb-4">
          <div class="flex items-center gap-2 text-xs text-slate-400">
            <span class="w-2 h-2 rounded-full bg-emerald-400"></span>
            <span id="data-status-text">ë¡œì»¬ ë”ë¯¸ ë°ì´í„°ì—ì„œ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘</span>
          </div>
          <button
            id="reload-button"
            class="inline-flex items-center gap-2 rounded-lg border border-slate-600 px-3 py-1.5 text-xs text-slate-100 hover:bg-slate-700/80 transition-colors"
          >
            ğŸ”„ ë°ì´í„° ìƒˆë¡œê³ ì¹¨
          </button>
        </div>

        <!-- íŒ€ë³„ ìš”ì•½ í…Œì´ë¸” -->
        <div class="overflow-x-auto rounded-xl border border-slate-700 bg-slate-900/40">
          <table class="min-w-full divide-y divide-slate-700 text-sm">
            <thead class="bg-slate-900/80">
              <tr>
                <th class="px-4 py-2 text-left text-xs font-semibold text-slate-300">ìˆœìœ„</th>
                <th class="px-4 py-2 text-left text-xs font-semibold text-slate-300">íŒ€ëª…</th>
                <th class="px-4 py-2 text-right text-xs font-semibold text-slate-300">íŒ€ì› ìˆ˜</th>
                <th class="px-4 py-2 text-right text-xs font-semibold text-slate-300">ì´ì </th>
                <th class="px-4 py-2 text-right text-xs font-semibold text-slate-300">í‰ê·  ì ìˆ˜</th>
                <th class="px-4 py-2 text-right text-xs font-semibold text-slate-300">ìµœê³  ì ìˆ˜</th>
              </tr>
            </thead>
            <tbody id="team-summary-body" class="divide-y divide-slate-800">
              <!-- JSì—ì„œ ì±„ì›Œì§ -->
            </tbody>
          </table>
        </div>

        <!-- í•˜ë‹¨ ì•ˆë‚´ -->
        <p class="mt-4 text-xs text-slate-400">
          âš™ï¸ í˜„ì¬ëŠ” ì˜ˆì‹œ ë°ì´í„°ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. ì‹¤ì œ Firebase / ì„œë²„ ì—°ë™ ì‹œ
          <code class="px-1.5 py-0.5 rounded bg-slate-800 border border-slate-700 text-[11px]">
            loadDataFromFirebase()
          </code>
          í•¨ìˆ˜ì˜ URLë§Œ ë‹¹ì‹  í”„ë¡œì íŠ¸ì— ë§ê²Œ ë°”ê¾¸ë©´ ë©ë‹ˆë‹¤.
        </p>
      </div>
    </div>
  </div>

  <script>
    // === ì„¤ì • ===
    const ADMIN_PASSWORD = "1016";

    // â­ ì‹¤ì œ ì ìˆ˜ ë°ì´í„° í˜•íƒœ ì˜ˆì‹œ
    //   team: íŒ€ ì´ë¦„
    //   name: í•™ìƒ ì´ë¦„
    //   score: ì ìˆ˜ (ìˆ«ì)
    //   createdAt: íƒ€ì„ìŠ¤íƒ¬í”„ (ì„ íƒ)
    const dummyScores = [
      { team: "Team A", name: "Student 1", score: 95, createdAt: 1733200000000 },
      { team: "Team A", name: "Student 2", score: 80, createdAt: 1733201000000 },
      { team: "Team B", name: "Student 3", score: 88, createdAt: 1733202000000 },
      { team: "Team B", name: "Student 4", score: 77, createdAt: 1733203000000 },
      { team: "Team C", name: "Student 5", score: 100, createdAt: 1733204000000 },
      { team: "Team C", name: "Student 6", score: 92, createdAt: 1733205000000 },
      { team: "Team C", name: "Student 7", score: 70, createdAt: 1733206000000 },
    ];

    let rawScores = [...dummyScores];

    const loginSection = document.getElementById("login-section");
    const loginError = document.getElementById("login-error");
    const loginButton = document.getElementById("login-button");
    const passwordInput = document.getElementById("admin-password");
    const adminSection = document.getElementById("admin-section");
    const loginStatusBadge = document.getElementById("login-status-badge");

    const summaryTeamCount = document.getElementById("summary-team-count");
    const summaryGlobalAvg = document.getElementById("summary-global-avg");
    const summaryRecordCount = document.getElementById("summary-record-count");
    const dataStatusText = document.getElementById("data-status-text");
    const reloadButton = document.getElementById("reload-button");
    const teamSummaryBody = document.getElementById("team-summary-body");

    // --- ë¡œê·¸ì¸ ì²˜ë¦¬ ---
    function handleLogin() {
      const value = passwordInput.value.trim();
      if (value === ADMIN_PASSWORD) {
        loginError.classList.add("hidden");
        loginSection.classList.add("hidden");
        adminSection.classList.remove("hidden");
        loginStatusBadge.textContent = "âœ… ì–´ë“œë¯¼ ë¡œê·¸ì¸ ì™„ë£Œ";
        loginStatusBadge.className =
          "text-xs px-3 py-1 rounded-full border border-emerald-400/60 text-emerald-300 bg-emerald-500/10";

        // ë¡œê·¸ì¸ ì„±ê³µ ì‹œ ë°ì´í„° ë Œë”ë§
        renderAll();
      } else {
        loginError.classList.remove("hidden");
        passwordInput.focus();
      }
    }

    loginButton.addEventListener("click", handleLogin);
    passwordInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        handleLogin();
      }
    });

    // --- íŒ€ë³„ ì§‘ê³„ ---
    function aggregateByTeam(scores) {
      const teamMap = {};

      scores.forEach((record) => {
        const teamName = record.team || "íŒ€ ë¯¸ì§€ì •";
        const score = Number(record.score) || 0;

        if (!teamMap[teamName]) {
          teamMap[teamName] = {
            team: teamName,
            total: 0,
            count: 0,
            max: 0,
          };
        }

        teamMap[teamName].total += score;
        teamMap[teamName].count += 1;
        if (score > teamMap[teamName].max) {
          teamMap[teamName].max = score;
        }
      });

      const list = Object.values(teamMap).map((t) => ({
        ...t,
        avg: t.count > 0 ? t.total / t.count : 0,
      }));

      // ì´ì  ê¸°ì¤€ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
      list.sort((a, b) => b.total - a.total);
      return list;
    }

    // --- ë Œë”ë§ ---
    function renderSummaryCards(scores) {
      const teamList = aggregateByTeam(scores);

      summaryTeamCount.textContent = teamList.length.toString();
      summaryRecordCount.textContent = scores.length.toString();

      if (scores.length === 0) {
        summaryGlobalAvg.textContent = "-";
      } else {
        const totalScore = scores.reduce(
          (sum, r) => sum + (Number(r.score) || 0),
          0
        );
        const globalAvg = totalScore / scores.length;
        summaryGlobalAvg.textContent = globalAvg.toFixed(1);
      }
    }

    function renderTeamTable(scores) {
      const teamList = aggregateByTeam(scores);
      teamSummaryBody.innerHTML = "";

      if (teamList.length === 0) {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td colspan="6" class="px-4 py-4 text-center text-xs text-slate-400">
            í‘œì‹œí•  íŒ€ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.
          </td>
        `;
        teamSummaryBody.appendChild(row);
        return;
      }

      teamList.forEach((team, index) => {
        const row = document.createElement("tr");

        // ìˆœìœ„ì— ë”°ë¼ ë±ƒì§€ ìŠ¤íƒ€ì¼ ì¡°ê¸ˆ ë‹¤ë¥´ê²Œ
        let rankBadgeClass = "bg-slate-800/80 text-slate-200";
        if (index === 0) rankBadgeClass = "bg-yellow-500/20 text-yellow-300";
        else if (index === 1) rankBadgeClass = "bg-sky-500/20 text-sky-300";
        else if (index === 2) rankBadgeClass = "bg-emerald-500/20 text-emerald-300";

        row.innerHTML = `
          <td class="px-4 py-2 text-xs">
            <span class="inline-flex items-center justify-center w-7 h-7 rounded-full ${rankBadgeClass} font-semibold">
              ${index + 1}
            </span>
          </td>
          <td class="px-4 py-2 text-sm font-semibold text-slate-100">
            ${team.team}
          </td>
          <td class="px-4 py-2 text-right text-sm text-slate-200">
            ${team.count}
          </td>
          <td class="px-4 py-2 text-right text-sm text-slate-200">
            ${team.total}
          </td>
          <td class="px-4 py-2 text-right text-sm text-slate-200">
            ${team.avg.toFixed(1)}
          </td>
          <td class="px-4 py-2 text-right text-sm text-slate-200">
            ${team.max}
          </td>
        `;
        teamSummaryBody.appendChild(row);
      });
    }

    function renderAll() {
      renderSummaryCards(rawScores);
      renderTeamTable(rawScores);
    }

    // --- ì‹¤ì œ Firebase / ì„œë²„ ì—°ë™ ì‹œ ì‚¬ìš©í•˜ëŠ” í•¨ìˆ˜ ì˜ˆì‹œ ---
    async function loadDataFromFirebase() {
      try {
        dataStatusText.textContent = "Firebaseì—ì„œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";

        // âœ… ì—¬ê¸°ë¥¼ ë‹¹ì‹  í”„ë¡œì íŠ¸ì˜ Realtime DB ê²½ë¡œë¡œ êµì²´
        // ì˜ˆ: https://your-project-id-default-rtdb.asia-southeast1.firebasedatabase.app/scores.json
        const response = await fetch(
          "https://ga4-project-grading-default-rtdb.asia-southeast1.firebasedatabase.app/ga4_evaluations.json"
        );

        const data = await response.json();

        // ë°ì´í„° êµ¬ì¡°ì— ë§ê²Œ ë³€í™˜
        // ì˜ˆ: { pushKey1: { team, name, score }, pushKey2: {...} }
        const list = [];
        if (data) {
          Object.values(data).forEach((item) => {
            if (!item) return;
            list.push({
              team: item.team || "íŒ€ ë¯¸ì§€ì •",
              name: item.name || item.studentName || "ì´ë¦„ ë¯¸ê¸°ì…",
              score: Number(item.score || item.points || 0),
              createdAt: item.createdAt || null,
            });
          });
        }

        if (list.length === 0) {
          dataStatusText.textContent =
            "Firebaseì— ì ìˆ˜ ë°ì´í„°ê°€ ì—†ì–´ì„œ ë”ë¯¸ ë°ì´í„°ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.";
          rawScores = [...dummyScores];
        } else {
          dataStatusText.textContent =
            `Firebaseì—ì„œ ${list.length}ê°œì˜ ê¸°ë¡ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`;
          rawScores = list;
        }

        renderAll();
      } catch (error) {
        console.error(error);
        dataStatusText.textContent =
          "Firebaseì—ì„œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë”ë¯¸ ë°ì´í„°ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.";
        rawScores = [...dummyScores];
        renderAll();
      }
    }

    // ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ í´ë¦­ ì‹œ Firebaseì—ì„œ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
    reloadButton.addEventListener("click", () => {
      loadDataFromFirebase();
    });

    // ì´ˆê¸° ìƒíƒœ ì•ˆë‚´
    dataStatusText.textContent =
      "í˜„ì¬ëŠ” ì˜ˆì‹œ ë”ë¯¸ ë°ì´í„°ë¥¼ ì‚¬ìš© ì¤‘ì…ë‹ˆë‹¤. (ë¡œê·¸ì¸ í›„ ìš”ì•½ í™•ì¸ ê°€ëŠ¥)";
  </script>
</body>
</html>
