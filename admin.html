<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>GA4 í”„ë¡œì íŠ¸ í‰ê°€ Â· íŒ€ë³„ ì ìˆ˜ ìš”ì•½ ADMIN</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Apple SD Gothic Neo",
        "Malgun Gothic", sans-serif;
    }
  </style>
</head>

<body class="bg-slate-900 text-slate-100 min-h-screen flex items-center justify-center p-4">

<div class="w-full max-w-5xl">
  <div class="bg-slate-800/90 border border-slate-700 rounded-2xl shadow-2xl overflow-hidden">

    <!-- í—¤ë” -->
    <div class="px-6 py-4 border-b border-slate-700 flex justify-between items-center">
      <div>
        <h1 class="text-xl font-bold">GA4 í”„ë¡œì íŠ¸ íŒ€ë³„ ì ìˆ˜ ìš”ì•½</h1>
        <p class="text-sm text-slate-400 mt-1">ê´€ë¦¬ì ë¡œê·¸ì¸ í›„ íŒ€ë³„ ì´ì  / í‰ê·  / íŒ€ì› ë³´ê¸°</p>
      </div>
      <span id="login-badge"
            class="text-xs px-3 py-1 rounded-full border border-amber-400/50 text-amber-300 bg-amber-500/10">
        ğŸ”’ ì ê¸ˆ
      </span>
    </div>

    <!-- ë¡œê·¸ì¸ ì„¹ì…˜ -->
    <div id="login-section" class="px-6 py-5 flex flex-col md:flex-row gap-3">
      <input
        id="admin-password"
        placeholder="ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ì…ë ¥"
        type="password"
        class="flex-1 rounded-xl px-3 py-2 bg-slate-900 border border-slate-700 focus:outline-none focus:ring-2 focus:ring-sky-500"
      />
      <button
        id="login-button"
        class="px-5 py-2 rounded-xl bg-sky-500 hover:bg-sky-600 text-sm font-semibold"
      >
        ğŸ”‘ ë¡œê·¸ì¸
      </button>
    </div>

    <!-- ë¡œê·¸ì¸ ì˜¤ë¥˜ -->
    <p id="login-error" class="px-6 pb-3 text-xs text-red-400 hidden">
      ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.
    </p>

    <div class="border-t border-slate-700"></div>

    <!-- ì–´ë“œë¯¼ ì½˜í…ì¸  -->
    <div id="admin-section" class="px-6 py-6 hidden">

      <!-- ìš”ì•½ ì¹´ë“œ -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-5">
        <div class="bg-slate-900/50 border border-slate-700 rounded-xl p-4">
          <p class="text-xs text-slate-400 mb-1">ì´ íŒ€ ìˆ˜</p>
          <p id="sum-teams" class="text-2xl font-bold">-</p>
        </div>

        <div class="bg-slate-900/50 border border-slate-700 rounded-xl p-4">
          <p class="text-xs text-slate-400 mb-1">ì „ì²´ í‰ê·  ì ìˆ˜</p>
          <p id="sum-avg" class="text-2xl font-bold">-</p>
        </div>

        <div class="bg-slate-900/50 border border-slate-700 rounded-xl p-4">
          <p class="text-xs text-slate-400 mb-1">í‰ê°€ ê¸°ë¡ ìˆ˜</p>
          <p id="sum-count" class="text-2xl font-bold">-</p>
        </div>
      </div>

      <!-- ìƒˆë¡œê³ ì¹¨ -->
      <div class="flex justify-between items-center mb-4 text-xs text-slate-400">
        <span id="data-status">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span>
        <button id="reload-btn"
          class="px-3 py-1.5 rounded-lg border border-slate-600 hover:bg-slate-700/70">
          ğŸ”„ ìƒˆë¡œê³ ì¹¨
        </button>
      </div>

      <!-- í…Œì´ë¸” -->
      <div class="overflow-x-auto border border-slate-700 rounded-xl">
        <table class="min-w-full text-sm divide-y divide-slate-700">
          <thead class="bg-slate-900/70">
            <tr>
              <th class="px-4 py-2 text-left text-xs text-slate-300">ìˆœìœ„</th>
              <th class="px-4 py-2 text-left text-xs text-slate-300">íŒ€ëª…</th>
              <th class="px-4 py-2 text-left text-xs text-slate-300">íŒ€ì›</th>
              <th class="px-4 py-2 text-right text-xs text-slate-300">ì´ì </th>
              <th class="px-4 py-2 text-right text-xs text-slate-300">í‰ê· </th>
              <th class="px-4 py-2 text-right text-xs text-slate-300">ìµœê³ ì </th>
            </tr>
          </thead>
          <tbody id="team-body" class="divide-y divide-slate-800">
          </tbody>
        </table>
      </div>

    </div>
  </div>
</div>

<script>
  // -------------------------------
  // ê¸°ë³¸ ì„¤ì •
  // -------------------------------
  const ADMIN_PASS = "1016";
  const DB_URL =
    "https://ga4-project-grading-default-rtdb.asia-southeast1.firebasedatabase.app/ga4_evaluations.json";

  const loginSection = document.getElementById("login-section");
  const adminSection = document.getElementById("admin-section");
  const loginButton = document.getElementById("login-button");
  const loginError = document.getElementById("login-error");
  const loginBadge = document.getElementById("login-badge");
  const passInput = document.getElementById("admin-password");

  const dataStatus = document.getElementById("data-status");
  const reloadBtn = document.getElementById("reload-btn");

  const teamBody = document.getElementById("team-body");

  const sumTeams = document.getElementById("sum-teams");
  const sumAvg = document.getElementById("sum-avg");
  const sumCount = document.getElementById("sum-count");

  // -------------------------------
  // ë¡œê·¸ì¸ ì²˜ë¦¬
  // -------------------------------
  function handleLogin() {
    if (passInput.value.trim() === ADMIN_PASS) {
      loginSection.classList.add("hidden");
      adminSection.classList.remove("hidden");
      loginBadge.textContent = "ğŸŸ¢ ë¡œê·¸ì¸ë¨";
      loginBadge.className =
        "text-xs px-3 py-1 rounded-full border border-emerald-400 text-emerald-300 bg-emerald-500/10";

      loadData();
    } else {
      loginError.classList.remove("hidden");
    }
  }

  loginButton.addEventListener("click", handleLogin);
  passInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") handleLogin();
  });

  // -------------------------------
  // Firebase ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
  // -------------------------------
  async function loadData() {
    try {
      dataStatus.textContent = "Firebaseì—ì„œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";

      const res = await fetch(DB_URL);
      const json = await res.json();

      if (!json) {
        dataStatus.textContent = "ë°ì´í„° ì—†ìŒ";
        return;
      }

      // ë°ì´í„° ë³€í™˜
      const rows = Object.values(json).map((item) => ({
        team: item?.scores?.teamName || "íŒ€ ë¯¸ì§€ì •",
        score: Number(item?.scores?.totalScore || 0),
        members: item?.members || "",
      }));

      render(rows);

      dataStatus.textContent = `ì´ ${rows.length}ê°œ í‰ê°€ ê¸°ë¡ ë¶ˆëŸ¬ì˜´`;

    } catch (err) {
      console.error(err);
      dataStatus.textContent = "ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜";
    }
  }

  // -------------------------------
  // ë Œë”ë§
  // -------------------------------
  function render(rows) {
    // íŒ€ë³„ ì§‘ê³„
    const teamMap = {};

    rows.forEach((item) => {
      if (!teamMap[item.team]) {
        teamMap[item.team] = {
          team: item.team,
          members: item.members,
          total: 0,
          count: 0,
          max: 0,
        };
      }

      teamMap[item.team].total += item.score;
      teamMap[item.team].count += 1;
      teamMap[item.team].max = Math.max(teamMap[item.team].max, item.score);
    });

    const teams = Object.values(teamMap).map((t) => ({
      ...t,
      avg: t.total / t.count,
    }));

    teams.sort((a, b) => b.total - a.total);

    // ìš”ì•½ ì¹´ë“œ
    sumTeams.textContent = teams.length;
    sumCount.textContent = rows.length;
    sumAvg.textContent =
      rows.length > 0
        ? (rows.reduce((a, b) => a + b.score, 0) / rows.length).toFixed(1)
        : "-";

    // í…Œì´ë¸” ë Œë”ë§
    teamBody.innerHTML = "";

    teams.forEach((t, i) => {
      const tr = document.createElement("tr");

      tr.innerHTML = `
        <td class="px-4 py-2">${i + 1}</td>
        <td class="px-4 py-2 font-semibold">${t.team}</td>
        <td class="px-4 py-2">${t.members}</td>
        <td class="px-4 py-2 text-right">${t.total}</td>
        <td class="px-4 py-2 text-right">${t.avg.toFixed(1)}</td>
        <td class="px-4 py-2 text-right">${t.max}</td>
      `;

      teamBody.appendChild(tr);
    });
  }

  reloadBtn.addEventListener("click", loadData);
</script>
</body>
</html>
